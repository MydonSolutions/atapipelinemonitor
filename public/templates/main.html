<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>ATA Pipeline Monitor</title>
	<style>
		.page {
			background-color: #123456;
			display:"flex";
			flex-direction:"column";
			position: absolute;
		}
		.panelrow{
			display: flex;
			justify-content: space-around;
		}

		.genericpanel {
			color: #FFFFFF;
			min-width: 300px;
			min-height: 200px;
			border: none;
			margin: 20px;
			padding: 20px 20px;
			font-family: 'Courier';
			font-size: 14px;
			text-align: 'left';
			line-height: 7px;
		}

		.genericpanel:hover{
			filter: brightness(115%);
		}

	</style>
</head>
<body>

	<div id="root"></div> 
	
</body>
<script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
<script src="https://npmcdn.com/babel-core@5.8.38/browser.min.js"></script>
<script type="text/babel">
	
	function fetchBasics(nodenum, instancenum){
		let req = new XMLHttpRequest;
		req.open("GET", "/basics?nodenum=" + nodenum + "&instancenum=" + instancenum)
		req.send()
			
		req.onreadystatechange = function(){
			if (this.readyState == 4 && this.status == 200){
				let text = req.responseText.replace("[", "").replace("]", "")
				text = text.replaceAll('null', '"null"')

				let spl = text.split('","')
				let daqpulse = spl[0].replace('"', '')
				let synctime = spl[1]
				let daqstate = spl[2]
				let physgbps = spl[3]
				let ibvgbps  = spl[4]
				let antnames = spl[5]
				let obsndrop = spl[6].replace('"', '')
				let ppstatus = spl[7]
				let postproc = spl[8].replace('"', '')
				let obsinfo = spl[9].replace('"', '')

				text = "<br></br>"
				text += "DAQPULSE " + daqpulse + "<br></br>"
				text += "SYNCTIME " + synctime + "<br></br>"
				text += "DAQSTATE " + daqstate + "<br></br>"
				text += "PHYSGBPS " + physgbps + "<br></br>"
				text += "IBVGBPS&nbsp;&nbsp;" + ibvgbps  + "<br></br>"
				text += "ANTNAMES " + antnames + "<br></br>"
				text += "OBSNDROP " + obsndrop + "<br></br>"
				text += "PPSTATUS " + ppstatus + "<br></br>"
				text += "POSTPROC " + postproc + "<br></br>"
				text += "OBSINFO&nbsp;&nbsp;" + obsinfo
				document.getElementById(nodenum + "_" + instancenum + "_basics").innerHTML = text
			}
		}
	}
	
	class Panel extends React.Component {
		componentDidMount() {
			let nodenum = this.props.nodenum;
			let instancenum = this.props.instancenum;
			this.fetchBasicsTimer = setInterval(function(){fetchBasics(nodenum, instancenum)}, 500)
		}

		componentWillUnMount() {
			clearInterval(this.timer);
		}

		render() {
			return (
				<a href={"/node?nodenum="+this.props.nodenum+"&instancenum="+this.props.instancenum}>
					<div 
						className="genericpanel" 
						id={"seti-node" + this.props.nodenum + "/" + this.props.instancenum}  
						style={{
							backgroundColor: this.props.color
						}}
					>
						<b>seti-node{Math.floor(this.props.nodenum)}/{this.props.instancenum}</b>
						<span id={this.props.nodenum + "_" + this.props.instancenum + "_basics"}></span>
					</div>
				</a>
			);
		}
	}

	class PanelRow extends React.Component {
		render(){
			return (
				<div className="panelrow">
					<React.Fragment>
						{this.props.nodenums.map(
							(nodenum, index) => {
								// console.log(index, this.props.rowtops[this.props.instancenum], this.props.collefts[(nodenum-1)%4], this.props.rowcolors[this.props.instancenum]);
								return <Panel key={"Panel_" + nodenum + "_" + this.props.instancenum} nodenum={nodenum} instancenum={this.props.instancenum} color={this.props.rowcolors[this.props.instancenum]}/>
							}
						)}
					</React.Fragment>
				</div>
			);
		}
	}

	class Page extends React.Component {
		render(){
			return (
				<div className="page">
					<React.Fragment>{
						this.props.instance_nodenums.map((instance_nodenums, instancenum) =>{
							return <PanelRow 
								key={"PanelRow_" + instancenum}
								instancenum={instancenum}
								nodenums={instance_nodenums}
								rowcolors={this.props.rowcolors}
							/>
						})
					}
					</React.Fragment>
				</div>
			);
		}
	}

	let instance_nodenums= [
				[1,2,3,4,5,6,7,8],
				[1,2,3,4,5,6,7,8],
			]
	
	ReactDOM.render(<Page 
			instance_nodenums={instance_nodenums}
			rowcolors={["#456789", "#987654"]}
		/>,
		document.getElementById('root')
	)


	setInterval(function(){
		var ping = new XMLHttpRequest;
		ping.open("GET", "/ping")
		ping.send()
	}, 10000)

</script>
</html>
